# TECH SPEC: Telegram Mini App Chess (MVP)

## 1. Цель
Создать Telegram Mini App (мобильный web-app), где пользователи играют в шахматы 1v1 онлайн с лобби, авторизацией через Telegram, статистикой и рейтингом.

## 2. Формат и размещение
- Приложение должно открываться внутри Telegram (WebApp).
- Размещение допустимо на любом хостинге с HTTPS.
- Приоритет: стабильная работа realtime-сессий.

## 3. Scope MVP
### Входит
- Авторизация через Telegram WebApp initData (серверная валидация подписи).
- Лобби:
- автоподбор соперника;
- выбор соперника по нику из списка ожидающих.
- Онлайн-партия 1v1.
- Полные классические правила шахмат.
- Синхронизация ходов в realtime.
- Кнопки: "Предложить ничью", "Сдаться", "Реванш".
- Хранение всех партий (лог ходов + результат).
- Личная статистика: победы/поражения/ничьи/всего игр.
- Общий рейтинг игроков.
- Суточный рейтинг и определение победителя дня.
- Интерфейс только на русском.
- Минималистичный мобильный UI.

### Не входит
- Игра с ботом.
- Античит.
- Таймеры и контроль времени.
- Админка/модерация.
- Мультиязычность.

## 4. Пользовательские сценарии
1. Пользователь открывает Mini App в Telegram.
2. Сервер проверяет Telegram initData.
3. Пользователь попадает в лобби.
4. Пользователь выбирает:
- "Найти игру" (автоочередь), или
- "Ожидающие" -> выбор ника -> вызов.
5. После матчинга создается партия.
6. Игроки ходят по очереди, ходы валидируются на сервере.
7. Во время игры доступны: ничья/сдача.
8. По завершению обновляются статистика и рейтинг.
9. Опционально: реванш по согласию двух игроков.

## 5. Функциональные требования
### FR-1 Авторизация
- Только Telegram WebApp auth.
- Сервер обязан проверять подпись initData.
- При первом входе создается профиль игрока.

### FR-2 Профиль
- Поля: tg_id, username, display_name, avatar_url, created_at.

### FR-3 Лобби и presence
- Статусы: online, in_queue, in_game.
- Защита от дублирующих заявок в очередь.
- Список ожидающих доступен в реальном времени.

### FR-4 Матчмейкинг
- Автоподбор: FIFO-очередь.
- Ручной вызов: отправка инвайта и ответ "принять/отклонить".

### FR-5 Игровая логика
- Сервер хранит authoritative-состояние игры.
- Сервер валидирует каждый ход.
- Поддержка: рокировка, взятие на проходе, превращение пешки.
- Завершения: мат, пат, ничья по согласию, сдача, троекратное повторение, правило 50 ходов, недостаток материала.

### FR-6 Realtime
- Двусторонний канал WebSocket.
- События состояния партии транслируются обоим игрокам.
- Поддержка реконнекта и восстановления актуального game_state.

### FR-7 Статистика и история
- Для каждого игрока: wins, losses, draws, games_total.
- Все завершенные партии сохраняются с логом ходов.
- История доступна для просмотра.

### FR-8 Рейтинг
- Общий рейтинг: суммарные очки за все время.
- Суточный рейтинг: очки за календарные сутки (фиксированный timezone).
- Определение победителя дня автоматически.

### FR-9 Пост-матч
- Кнопка "Реванш" доступна после завершения.
- Новая партия создается при согласии обеих сторон.

## 6. Правила начисления очков
- Победа: +3
- Ничья: +1
- Поражение: +0

### Tie-break для суточного рейтинга
1. Больше очков.
2. Больше побед.
3. Меньше поражений.
4. Раньше достигнут итоговый результат.

## 7. Нефункциональные требования
- Стабильность важнее таймеров и доп. механик.
- Целевая задержка доставки хода: до 500 мс при нормальной сети.
- Идемпотентность обработки ходов (защита от повторной отправки).
- Полный аудит логов партий и завершений.
- Только HTTPS.

## 8. Архитектура (рекомендуемая)
- Frontend: Telegram Mini App (React).
- Backend: Node.js (NestJS/Fastify/Express).
- Realtime: WebSocket (Socket.IO или ws).
- DB: PostgreSQL.
- Redis: очередь и эфемерные realtime-состояния.

Примечание: хостинг backend должен поддерживать постоянные соединения и не "усыплять" сервис во время игры.

## 9. Схема данных (минимум)
### users
- id (uuid)
- tg_id (bigint, unique)
- username (text, nullable)
- display_name (text)
- avatar_url (text, nullable)
- created_at
- updated_at

### player_stats
- user_id (fk, unique)
- wins
- losses
- draws
- games_total
- points_total
- updated_at

### games
- id (uuid)
- white_user_id (fk)
- black_user_id (fk)
- status (active/finished/aborted)
- result (1-0/0-1/1/2-1/2/*)
- finish_reason
- fen_current
- pgn
- started_at
- finished_at

### moves
- id (uuid)
- game_id (fk)
- move_no
- side (w/b)
- uci
- san
- fen_after
- created_at

### daily_leaderboard
- day_date (date)
- user_id (fk)
- points_day
- wins_day
- losses_day
- draws_day
- rank
- finalized_at

## 10. API контракты (черновик)
### REST
- POST /auth/telegram
- GET /me
- GET /lobby/waiting
- POST /lobby/queue/join
- POST /lobby/queue/leave
- POST /lobby/challenge
- POST /lobby/challenge/respond
- GET /games/:id
- GET /leaderboard/global
- GET /leaderboard/daily?date=YYYY-MM-DD
- GET /history?userId=...

### WebSocket events
- queue:joined
- queue:left
- match:found
- game:state
- game:move
- game:move:applied
- game:draw:offer
- game:draw:respond
- game:resign
- game:finished
- game:rematch:offer
- game:rematch:accepted
- presence:update

## 11. Критерии приемки MVP
- Авторизация через Telegram работает на серверной проверке подписи.
- 2 игрока могут начать матч через автоподбор.
- 2 игрока могут начать матч через вызов по нику.
- Все классические правила соблюдаются корректно.
- Ходы синхронны на обоих клиентах.
- Ничья/сдача/реванш работают.
- Статистика и рейтинг обновляются после каждой завершенной партии.
- Все партии сохраняются в истории.
- Суточный лидер определяется автоматически по заданным правилам.
- UI корректно работает в мобильном Telegram.

## 12. План реализации
1. Telegram auth + профиль.
2. Лобби + presence + очередь.
3. Матчмейкинг (авто + вызовы).
4. Игровая сессия и серверная валидация ходов.
5. Realtime и реконнект.
6. История игр и статистика.
7. Общий и суточный рейтинг.
8. Тесты и deploy в Telegram.
